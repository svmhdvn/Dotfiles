#!/bin/sh
set -e

jail=r140x64
emptdir="$HOME/src/empt/poudriere"
sivadir="$HOME/dotfiles/host_specific/xeon"

case $1 in
  xeon)
    pkgfile="$sivadir/poudriere-pkglist.txt"
    ;;
  cl100|wyse)
    pkgfile="$emptdir/empt-pkglist.txt"
    ;;
  *)
    >&2 echo "unsupported host: $1"
    >&2 echo "usage: $0 <host> <options|bulk>"
    exit 1
esac

if test ! -r "$pkgfile"; then
  >&2 echo "file not found: $pkgfile"
  exit 1
fi

case $2 in
  bulk|options)
    doas poudriere $2 -j "$jail" -p local -f "$pkgfile" -z "$1"
    ;;
  backup)
    cp -RP "/usr/local/etc/poudriere.d/$jail-local-xeon-options" "$sivadir/"
#    cp -RP "/usr/local/etc/poudriere.d/$jail-local-cl100-options" "$emptdir/"
    cp -RP "/usr/local/etc/poudriere.d/$jail-local-wyse-options" "$emptdir/"
    ;;
  tarball)
    tar --zstd --strip-components 7 -cvf "$HOME/poudriere-$1.tar.zst" \
      "/usr/local/poudriere/data/packages/$jail-local-$1"
    ;;
  *)
    >&2 echo "unsupported command: $2"
    exit 1
esac
