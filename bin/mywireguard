#!/bin/sh
set -e

# TODO find a cleaner way to assign numbers to every host I own
host="$(hostname)"
case $host in
	"pbp")		hostnum=2 ;;
	"think")	hostnum=3 ;;
	"cl100")	hostnum=4 ;;
	"wyse1")	hostnum=5 ;;
	*)
    		echo "unsupported host: '$1'" >&2
    		exit 1
esac

case $1 in
	"init")
		doas ip link add dev wg0 type wireguard
		doas ip address add dev wg0 "10.29.222.$hostnum/24"
		;;
	"up")
                OPENWRT_PEER='9TMsfDx2LYZRk5y+iRfVJCnxXadDdscy9jOQyoaRBi8='
                # TODO switch to IPv6; currently hardcoding as IPv4 since that's
                # what most public networks only support
                OPENWRT_PUBLIC_IP=$(dig +short A openwrt.empt.ca)
                OPENWRT_PORT=45036
		doas wg set wg0 \
			private-key "$HOME/secrets/wg0-privkey.txt" \
			peer "$OPENWRT_PEER" \
			allowed-ips '0.0.0.0/0,::/0' \
			endpoint "$OPENWRT_PUBLIC_IP:$OPENWRT_PORT"
		doas ip link set wg0 up
		doas ip address add dev wg0 "fe80::$hostnum/64"
		;;
	"down")
		doas ip link set wg0 down
		;;
	*)
		echo "unknown command: '$1'" >&2
		exit 1
esac
