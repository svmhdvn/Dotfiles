# My alpine linux laptop setup notes

Laptop specs:
* Lenovo ThinkPad E495
* AMD ryzen 3500U
* Radeon vega graphics (AMDGPU)
* 8 GB RAM (~5.76 GB usable, rest allocated for VRAM)
* 500GB SSD

## Initial installation

Start by following the install guide to do a normal sys-mode installation of alpine linux. I used the following
settings in the `setup-alpine` script:

keymap: us-colemak
hostname: alpine
networking: wlan0 (wpa_supplicant)
timezone: Canada/Eastern
mirror: CDN
ssh: none (will later install openssh for the sake of having the ssh client)
ntp: busybox
disk-install: sys

## Things to do as root user

### Right after first reboot

TODO might be useful to figure out how to immediately send udhcpc to the background. It takes forever
to get a lease.

* USEFUL PACKAGES TO INSTALL

```sh
apk add mandoc man-pages nano git git-doc 
```

* Turn on Kernel Modesetting (KMS)

First, enable KMS:

```sh
echo amdgpu >> /etc/modules
echo fbcon >> /etc/modules
```

and add it to the list of features enabled in mkinitfs config:

```
/etc/mkinitfs/mkinitfs.conf:

features="kms ..."
```

For some reason, the default installation of alpine linux specifically disables KMS through a GRUB command line
parameter. Remove that from the grub entry:

```
/etc/default/grub:

...
GRUB_CMDLINE_LINUX_DEFAULT="..." # remove 'nomodesetting' from here
```

Then regenerate grub config:

```sh
grub-mkconfig -o /boot/grub/grub.cfg
```

Finally reboot to enjoy the new "clean" system

## Casual setup

### Power management

Power management is surprisingly hard to debug and setup for the first time. No hand-holding at all. Here
are the steps I ended up with to get something working that I'm happy with (for now).

* ACPI laptop lid suspend

TODO clean up the editing commands

```sh
rc-update add acpid
rc-service start acpid
mkdir -p /etc/acpi/LID
echo '#!/bin/sh' >> /etc/acpi/LID/00000080
echo 'echo mem > /sys/power/state' >> /etc/acpi/LID/00000080
chmod +x /etc/acpi/LID/00000080
```

That should be good enough. I tried to use `pm-utils`, but it seems quite old and I had to mess around with
it too much. Unnecessary.

* Laptop mode tools (power savings for laptop)

This is a set of scripts that help with power saving on a laptop. I set up AC power adapter plug/unplug events
to enable/disable laptop-mode.

TODO maybe file issues or contribute back to this project to do the following things better for alpine
* Add OpenRC-based service script
* Remove the dependency on specific arguments in certain tools like `flock` that aren't supported in busybox
* Fix detection of ACPI (although I don't think it is very useful to do this anyway since AC adapter doesn't work)

```sh
git clone https://<laptop-mode-tools repo>
cd laptop-mode-tools
ACPI=force ./install # TODO figure out if this is the best way
```

Then set up the `mdev` event handlers:

```
/etc/mdev.conf:

...
# Add a section for your own custom handlers

SUBSYSTEM=power_supply;.*   root:root 0660 */usr/sbin/laptop_mode

# Make sure that the last item is still the fallback (i.e. don't add your custom section to the end)

# fallback for any!device -> any/device
...
```

### Sway window manager

First, follow the alpine wiki page on Sway exactly.

There's a lot of extra packages that need to be added to sway's dependencies to work correctly.

Here is a rough list for now:
* elogind
* mesa
* mesa-dri-gallium
* xkeyboard-config
